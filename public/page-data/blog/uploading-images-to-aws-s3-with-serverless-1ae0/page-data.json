{"componentChunkName":"component---src-templates-blog-js","path":"/blog/uploading-images-to-aws-s3-with-serverless-1ae0","result":{"data":{"devArticles":{"article":{"tags":["aws","serverless","saas","javascript"],"slug":"uploading-images-to-aws-s3-with-serverless-1ae0","title":"Uploading Images to AWS S3 with Serverless","cover_image":"https://res.cloudinary.com/practicaldev/image/fetch/s--cvDn9lgz--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/i/5uslgb7k0xlziyp7xy3c.jpeg","description":"AWS S3 is one of the many services provided by Amazon Web Services (AWS), which allows you to store f...","published_at":"Sep 24 2020","edited_at":null,"positive_reactions_count":0,"comments_count":0,"body_html":"<p><strong>AWS S3</strong> is one of the many services provided by <strong>Amazon Web Services (AWS)</strong>, which allows you to store files, most of you probably already know. On the other hand, <strong>AWS Lambda</strong> is one of the most revolutionary services of our day, although the name may sound very intimidating, AWS Lambda is a computing platform that autonomously manages the computing resources required by the developed code and can execute code to any type of application or back-end service, the purpose of this service is to simplify the creation of applications, because it is not necessary to provision or manage servers, since <strong>AWS Lambda</strong> also takes care of everything necessary to <strong>run and scale your code with high availability, in addition you pay on demand</strong>, that is, for the processing time involved in executing the code.</p>\n\n<p>The purpose of this post is to explain how to develop a back-end service, without a server <a href=\"https://aws.amazon.com/serverless/\">serverless</a>, to upload images (original and thumbnail), using the framework called <a href=\"https://www.serverless.com/\">serverless</a> by the way was developed by the <strong>Coca Cola company</strong>, for the purpose of creating serverless applications even faster; according to Wikipedia:</p>\n\n<p><em>Serverless Framework is a free, open source web framework written with Node.js. Serverless is the first framework developed to build applications on AWS Lambda, a serverless computing platform provided by Amazon as part of Amazon Web Services.</em></p>\n\n<p><strong>In the next few steps</strong>, I'll walk you through building a <strong>serveless based application</strong>, allowing <strong>image processing and uploading, on AWS S3</strong>, if you'd rather go straight to the code, <a href=\"https://github.com/foqc/serveless-upload-image\">here</a> it is.</p>\n\n<p><strong>Note:</strong> It is not recommended to use Lambdas for file uploads due to certain limitations of <a href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/limits.html\">Api Gateway</a> and <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html\">Lambdas</a>, if despite this you still want it, this blog is for you.</p>\n\n<p><strong>Required Tools</strong></p>\n\n<ul>\n<li>Node JS 12</li>\n<li>Serverless</li>\n<li>AWS CLI</li>\n</ul>\n\n<h3>\n  <a name=\"1-install-aws-cli-command-line-interface\" href=\"#1-install-aws-cli-command-line-interface\" class=\"anchor\">\n  </a>\n  1. Install AWS CLI (Command Line Interface)\n</h3>\n\n<p>AWS CLI, is a unified tool for managing AWS services, it is a tool that allows you to control multiple AWS services from the command line. Once downloaded, add your profile with your respective <a href=\"https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html\">AWS account and credential</a>.</p>\n\n<h3>\n  <a name=\"2-install-the-serverless-framework\" href=\"#2-install-the-serverless-framework\" class=\"anchor\">\n  </a>\n  2. Install the serverless framework\n</h3>\n\n<p>Here is a link that explains this process in detail, <a href=\"https://serverless.com/framework/docs/getting-started/\">https://serverless.com/framework/docs/getting-started/</a>.</p>\n\n<h3>\n  <a name=\"3-run-the-following-command-to-generate-sample-code-with-serverless\" href=\"#3-run-the-following-command-to-generate-sample-code-with-serverless\" class=\"anchor\">\n  </a>\n  3. Run the following command to generate sample code with serverless.\n</h3>\n\n<p>First you need to create a folder, example: <strong><em>serveless-upload-image</em></strong>.<br>\n</p>\n\n<div class=\"highlight\"><pre class=\"highlight shell\"><code>sls create <span class=\"nt\">--template</span> hello-world\n</code></pre></div>\n\n\n\n<p>The above command will create the following files:</p>\n\n<ul>\n<li>serverless.yml</li>\n<li>handler.js</li>\n</ul>\n\n<p>In the serverless.yml file, you will find all the information for the resources required by the developed code, for example the infrastructure provider to be used such as AWS, Google Cloud or Azure, the database to be used, the functions to be displayed, the events to be heard, the permissions to access each of the resources, among other things.</p>\n\n<p>The <strong>handle.js</strong> file contains the generated <strong><em>hello-world</em></strong> code, which is a simple function that returns a JSON document with status 200 and a message. We will rename this file to <strong>fileUploaderHome.js</strong>.</p>\n\n<h3>\n  <a name=\"4-install-dependencies\" href=\"#4-install-dependencies\" class=\"anchor\">\n  </a>\n  4. Install dependencies\n</h3>\n\n\n\n<div class=\"highlight\"><pre class=\"highlight shell\"><code>npm init <span class=\"nt\">-y</span>\nnpm <span class=\"nb\">install </span>busboy <span class=\"o\">&amp;&amp;</span> uuid <span class=\"o\">&amp;&amp;</span> jimp <span class=\"o\">&amp;&amp;</span> aws-sdk\n</code></pre></div>\n\n\n\n<p>Since handling files is required, the client will send a <strong>POST request</strong>, encoding the body in <strong><em>multipart/form-data</em></strong> format, to decode that format, for which we will use the <strong>busboy library</strong>. In addition, it is necessary to make a thumbnail of the images, <strong>Jimp</strong> will be installed, also the library called <strong>uuid</strong>, to generate a unique identifier for the images, finally, the <strong>AWS SDK</strong> provides JavaScript objects to manage AWS services, such as Amazon S3, Amazon EC2, DynamoDB among others.</p>\n\n<h3>\n  <a name=\"5-create-the-function-to-decode-the-multipartformdata\" href=\"#5-create-the-function-to-decode-the-multipartformdata\" class=\"anchor\">\n  </a>\n  5. Create the function to decode the multipart/form-data\n</h3>\n\n\n\n<div class=\"highlight\"><pre class=\"highlight javascript\"><code><span class=\"c1\">//formParser.js</span>\n<span class=\"kd\">const</span> <span class=\"nx\">Busboy</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">busboy</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span><span class=\"p\">.</span><span class=\"nx\">parser</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">event</span><span class=\"p\">,</span> <span class=\"nx\">fileZise</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span>\n    <span class=\"k\">new</span> <span class=\"nb\">Promise</span><span class=\"p\">((</span><span class=\"nx\">resolve</span><span class=\"p\">,</span> <span class=\"nx\">reject</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"kd\">const</span> <span class=\"nx\">busboy</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Busboy</span><span class=\"p\">({</span>\n        <span class=\"na\">headers</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"dl\">'</span><span class=\"s1\">content-type</span><span class=\"dl\">'</span><span class=\"p\">:</span>\n            <span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">headers</span><span class=\"p\">[</span><span class=\"dl\">'</span><span class=\"s1\">content-type</span><span class=\"dl\">'</span><span class=\"p\">]</span> <span class=\"o\">||</span> <span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">headers</span><span class=\"p\">[</span><span class=\"dl\">'</span><span class=\"s1\">Content-Type</span><span class=\"dl\">'</span><span class=\"p\">]</span>\n        <span class=\"p\">},</span>\n        <span class=\"na\">limits</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"nx\">fileZise</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">});</span>\n\n    <span class=\"kd\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"na\">files</span><span class=\"p\">:</span> <span class=\"p\">[]</span>\n    <span class=\"p\">};</span>\n\n    <span class=\"nx\">busboy</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">file</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">fieldname</span><span class=\"p\">,</span> <span class=\"nx\">file</span><span class=\"p\">,</span> <span class=\"nx\">filename</span><span class=\"p\">,</span> <span class=\"nx\">encoding</span><span class=\"p\">,</span> <span class=\"nx\">mimetype</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"kd\">const</span> <span class=\"nx\">uploadFile</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">data</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">data</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n            <span class=\"nx\">uploadFile</span><span class=\"p\">.</span><span class=\"nx\">content</span> <span class=\"o\">=</span> <span class=\"nx\">data</span>\n        <span class=\"p\">});</span>\n        <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">end</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">uploadFile</span><span class=\"p\">.</span><span class=\"nx\">content</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                <span class=\"nx\">uploadFile</span><span class=\"p\">.</span><span class=\"nx\">filename</span> <span class=\"o\">=</span> <span class=\"nx\">filename</span>\n                <span class=\"nx\">uploadFile</span><span class=\"p\">.</span><span class=\"nx\">contentType</span> <span class=\"o\">=</span> <span class=\"nx\">mimetype</span>\n                <span class=\"nx\">uploadFile</span><span class=\"p\">.</span><span class=\"nx\">encoding</span> <span class=\"o\">=</span> <span class=\"nx\">encoding</span>\n                <span class=\"nx\">uploadFile</span><span class=\"p\">.</span><span class=\"nx\">fieldname</span> <span class=\"o\">=</span> <span class=\"nx\">fieldname</span>\n                <span class=\"nx\">result</span><span class=\"p\">.</span><span class=\"nx\">files</span><span class=\"p\">.</span><span class=\"nx\">push</span><span class=\"p\">(</span><span class=\"nx\">uploadFile</span><span class=\"p\">)</span>\n             <span class=\"p\">}</span>\n        <span class=\"p\">})</span>\n    <span class=\"p\">})</span>\n\n    <span class=\"nx\">busboy</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">field</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">fieldname</span><span class=\"p\">,</span> <span class=\"nx\">value</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">result</span><span class=\"p\">[</span><span class=\"nx\">fieldname</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nx\">value</span>\n    <span class=\"p\">});</span>\n\n    <span class=\"nx\">busboy</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">error</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">error</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">reject</span><span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">)</span>\n    <span class=\"p\">})</span>\n\n    <span class=\"nx\">busboy</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">finish</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">result</span><span class=\"p\">);</span>\n    <span class=\"p\">})</span>\n\n    <span class=\"nx\">busboy</span><span class=\"p\">.</span><span class=\"nx\">write</span><span class=\"p\">(</span><span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">,</span> <span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">isBase64Encoded</span> <span class=\"p\">?</span> <span class=\"dl\">'</span><span class=\"s1\">base64</span><span class=\"dl\">'</span> <span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">binary</span><span class=\"dl\">'</span><span class=\"p\">)</span>\n    <span class=\"nx\">busboy</span><span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">()</span>\n <span class=\"p\">})</span>\n</code></pre></div>\n\n\n\n<h3>\n  <a name=\"6-function-that-will-process-and-upload-the-images-to-s3\" href=\"#6-function-that-will-process-and-upload-the-images-to-s3\" class=\"anchor\">\n  </a>\n  6. Function that will process and upload the images to S3\n</h3>\n\n<p>Below is the step-by-step code that will allow to process the original image and thumbnail to be uploaded to S3.<br>\n</p>\n\n<div class=\"highlight\"><pre class=\"highlight javascript\"><code><span class=\"c1\">//fileUploaderHome.js</span>\n<span class=\"dl\">\"</span><span class=\"s2\">use strict</span><span class=\"dl\">\"</span><span class=\"p\">;</span>\n<span class=\"kd\">const</span> <span class=\"nx\">AWS</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">aws-sdk</span><span class=\"dl\">\"</span><span class=\"p\">)</span>\n<span class=\"kd\">const</span> <span class=\"nx\">uuid</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">uuid/v4</span><span class=\"dl\">\"</span><span class=\"p\">)</span>\n<span class=\"kd\">const</span> <span class=\"nx\">Jimp</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">jimp</span><span class=\"dl\">\"</span><span class=\"p\">)</span>\n<span class=\"kd\">const</span> <span class=\"nx\">s3</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">AWS</span><span class=\"p\">.</span><span class=\"nx\">S3</span><span class=\"p\">()</span>\n<span class=\"kd\">const</span> <span class=\"nx\">formParser</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">./formParser</span><span class=\"dl\">\"</span><span class=\"p\">)</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">bucket</span> <span class=\"o\">=</span> <span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">env</span><span class=\"p\">.</span><span class=\"nx\">Bucket</span>\n<span class=\"kd\">const</span> <span class=\"nx\">MAX_SIZE</span> <span class=\"o\">=</span> <span class=\"mi\">4000000</span> <span class=\"c1\">// 4MB</span>\n<span class=\"kd\">const</span> <span class=\"nx\">PNG_MIME_TYPE</span> <span class=\"o\">=</span> <span class=\"dl\">\"</span><span class=\"s2\">image/png</span><span class=\"dl\">\"</span>\n<span class=\"kd\">const</span> <span class=\"nx\">JPEG_MIME_TYPE</span> <span class=\"o\">=</span> <span class=\"dl\">\"</span><span class=\"s2\">image/jpeg</span><span class=\"dl\">\"</span>\n<span class=\"kd\">const</span> <span class=\"nx\">JPG_MIME_TYPE</span> <span class=\"o\">=</span> <span class=\"dl\">\"</span><span class=\"s2\">image/jpg</span><span class=\"dl\">\"</span>\n<span class=\"kd\">const</span> <span class=\"nx\">MIME_TYPES</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"nx\">PNG_MIME_TYPE</span><span class=\"p\">,</span> <span class=\"nx\">JPEG_MIME_TYPE</span><span class=\"p\">,</span> <span class=\"nx\">JPG_MIME_TYPE</span><span class=\"p\">]</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span><span class=\"p\">.</span><span class=\"nx\">handler</span> <span class=\"o\">=</span> <span class=\"k\">async</span> <span class=\"nx\">event</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"k\">try</span> <span class=\"p\">{</span>\n        <span class=\"kd\">const</span> <span class=\"nx\">formData</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nx\">formParser</span><span class=\"p\">.</span><span class=\"nx\">parser</span><span class=\"p\">(</span><span class=\"nx\">event</span><span class=\"p\">,</span> <span class=\"nx\">MAX_SIZE</span><span class=\"p\">)</span>\n        <span class=\"kd\">const</span> <span class=\"nx\">file</span> <span class=\"o\">=</span> <span class=\"nx\">formData</span><span class=\"p\">.</span><span class=\"nx\">files</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">isAllowedFile</span><span class=\"p\">(</span><span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">content</span><span class=\"p\">.</span><span class=\"nx\">byteLength</span><span class=\"p\">,</span> <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">contentType</span><span class=\"p\">))</span>\n            <span class=\"nx\">getErrorMessage</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">File size or type not allowed</span><span class=\"dl\">\"</span><span class=\"p\">)</span>\n\n        <span class=\"kd\">const</span> <span class=\"nx\">uid</span> <span class=\"o\">=</span> <span class=\"nx\">uuid</span><span class=\"p\">()</span>\n        <span class=\"kd\">const</span> <span class=\"nx\">originalKey</span> <span class=\"o\">=</span> <span class=\"s2\">`</span><span class=\"p\">${</span><span class=\"nx\">uid</span><span class=\"p\">}</span><span class=\"s2\">_original_</span><span class=\"p\">${</span><span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">filename</span><span class=\"p\">}</span><span class=\"s2\">`</span>\n        <span class=\"kd\">const</span> <span class=\"nx\">thumbnailKey</span> <span class=\"o\">=</span> <span class=\"s2\">`</span><span class=\"p\">${</span><span class=\"nx\">uid</span><span class=\"p\">}</span><span class=\"s2\">_thumbnail_</span><span class=\"p\">${</span><span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">filename</span><span class=\"p\">}</span><span class=\"s2\">`</span>\n\n        <span class=\"kd\">const</span> <span class=\"nx\">fileResizedBuffer</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nx\">resize</span><span class=\"p\">(</span> <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">content</span><span class=\"p\">,</span> <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">contentType</span><span class=\"p\">,</span> <span class=\"mi\">460</span><span class=\"p\">)</span>\n        <span class=\"kd\">const</span> <span class=\"p\">[</span><span class=\"nx\">originalFile</span><span class=\"p\">,</span> <span class=\"nx\">thumbnailFile</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nb\">Promise</span><span class=\"p\">.</span><span class=\"nx\">all</span><span class=\"p\">([</span>\n            <span class=\"nx\">uploadToS3</span><span class=\"p\">(</span><span class=\"nx\">bucket</span><span class=\"p\">,</span> <span class=\"nx\">originalKey</span><span class=\"p\">,</span> <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">content</span><span class=\"p\">,</span> <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">contentType</span><span class=\"p\">),</span>\n            <span class=\"nx\">uploadToS3</span><span class=\"p\">(</span><span class=\"nx\">bucket</span><span class=\"p\">,</span> <span class=\"nx\">thumbnailKey</span><span class=\"p\">,</span> <span class=\"nx\">fileResizedBuffer</span><span class=\"p\">,</span> <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">contentType</span><span class=\"p\">)</span>\n        <span class=\"p\">])</span>\n\n        <span class=\"kd\">const</span> <span class=\"nx\">signedOriginalUrl</span> <span class=\"o\">=</span> <span class=\"nx\">s3</span><span class=\"p\">.</span><span class=\"nx\">getSignedUrl</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">getObject</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"p\">{</span> <span class=\"na\">Bucket</span><span class=\"p\">:</span> <span class=\"nx\">originalFile</span><span class=\"p\">.</span><span class=\"nx\">Bucket</span><span class=\"p\">,</span> <span class=\"na\">Key</span><span class=\"p\">:</span> <span class=\"nx\">originalKey</span><span class=\"p\">,</span> <span class=\"na\">Expires</span><span class=\"p\">:</span> <span class=\"mi\">60000</span> <span class=\"p\">})</span>\n        <span class=\"kd\">const</span> <span class=\"nx\">signedThumbnailUrl</span> <span class=\"o\">=</span> <span class=\"nx\">s3</span><span class=\"p\">.</span><span class=\"nx\">getSignedUrl</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">getObject</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"p\">{</span> <span class=\"na\">Bucket</span><span class=\"p\">:</span> <span class=\"nx\">thumbnailFile</span><span class=\"p\">.</span><span class=\"nx\">Bucket</span><span class=\"p\">,</span> <span class=\"na\">Key</span><span class=\"p\">:</span> <span class=\"nx\">thumbnailKey</span><span class=\"p\">,</span> <span class=\"na\">Expires</span><span class=\"p\">:</span> <span class=\"mi\">60000</span> <span class=\"p\">})</span>\n\n        <span class=\"k\">return</span> <span class=\"p\">{</span>\n            <span class=\"na\">statusCode</span><span class=\"p\">:</span> <span class=\"mi\">200</span><span class=\"p\">,</span>\n            <span class=\"na\">body</span><span class=\"p\">:</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">({</span>\n                <span class=\"na\">id</span><span class=\"p\">:</span> <span class=\"nx\">uid</span><span class=\"p\">,</span>\n                <span class=\"na\">mimeType</span><span class=\"p\">:</span> <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">contentType</span><span class=\"p\">,</span>\n                <span class=\"na\">originalKey</span><span class=\"p\">:</span> <span class=\"nx\">originalFile</span><span class=\"p\">.</span><span class=\"nx\">key</span><span class=\"p\">,</span>\n                <span class=\"na\">thumbnailKey</span><span class=\"p\">:</span> <span class=\"nx\">thumbnailFile</span><span class=\"p\">.</span><span class=\"nx\">key</span><span class=\"p\">,</span>\n                <span class=\"na\">bucket</span><span class=\"p\">:</span> <span class=\"nx\">originalFile</span><span class=\"p\">.</span><span class=\"nx\">Bucket</span><span class=\"p\">,</span>\n                <span class=\"na\">fileName</span><span class=\"p\">:</span> <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">filename</span><span class=\"p\">,</span>\n                <span class=\"na\">originalUrl</span><span class=\"p\">:</span> <span class=\"nx\">signedOriginalUrl</span><span class=\"p\">,</span>\n                <span class=\"na\">thumbnailUrl</span><span class=\"p\">:</span> <span class=\"nx\">signedThumbnailUrl</span><span class=\"p\">,</span>\n                <span class=\"na\">originalSize</span><span class=\"p\">:</span> <span class=\"nx\">file</span><span class=\"p\">.</span><span class=\"nx\">content</span><span class=\"p\">.</span><span class=\"nx\">byteLength</span>\n             <span class=\"p\">})</span>\n          <span class=\"p\">}</span>\n    <span class=\"p\">}</span> <span class=\"k\">catch</span> <span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"k\">return</span> <span class=\"nx\">getErrorMessage</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">message</span><span class=\"p\">)</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n\n\n<ul>\n<li><p>The <strong>resize</strong> function <strong>(file.content, file.contentType, 460)</strong>, will be explained in detail later, however in this line a <strong>thumbnail image</strong> is generated from the original image, with a width of 460 px, and a height determined automatically, this function receives the binary content of the original file, the type of the file and the size at which the thumbnail image will be generated. The await keyword will wait for the image resizing to finish processing to continue to the next line.</p></li>\n<li><p>The <strong>uploadToS3</strong> function receives 3 parameters, the bucket to which it will be uploaded, the key <strong>(key)</strong> of the file, the content in binary and the file type, and returns a promise, later on what this function does will be explained in detail.</p></li>\n<li><p>Once we have <strong>original and the thumbnail file</strong>, it is uploaded to S3, in parallel with <strong>Promise.all(...)</strong><em>, when it finishes uploading all files it returns an array with the information of each file that has been uploaded. Then the signed url *</em>(getSignedUrl)** is obtained, with a specified <strong>expiration time</strong>, using the AWS S3 client.<br>\nThis function, finally in case everything is executed successfully, returns a JSON, with the information of the processed images.</p></li>\n</ul>\n\n<p>In the following block, each one of the utilitarian functions used from the previous code block is detailed.<br>\n</p>\n\n<div class=\"highlight\"><pre class=\"highlight javascript\"><code><span class=\"kd\">const</span> <span class=\"nx\">getErrorMessage</span> <span class=\"o\">=</span> <span class=\"nx\">message</span> <span class=\"o\">=&gt;</span> <span class=\"p\">({</span> <span class=\"na\">statusCode</span><span class=\"p\">:</span> <span class=\"mi\">500</span><span class=\"p\">,</span> <span class=\"na\">body</span><span class=\"p\">:</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span> <span class=\"nx\">message</span> <span class=\"p\">})})</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">isAllowedFile</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">size</span><span class=\"p\">,</span> <span class=\"nx\">mimeType</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span> <span class=\"c1\">// some validation code }</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">uploadToS3</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">bucket</span><span class=\"p\">,</span> <span class=\"nx\">key</span><span class=\"p\">,</span> <span class=\"nx\">buffer</span><span class=\"p\">,</span> <span class=\"nx\">mimeType</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span>\n    <span class=\"k\">new</span> <span class=\"nb\">Promise</span><span class=\"p\">((</span><span class=\"nx\">resolve</span><span class=\"p\">,</span> <span class=\"nx\">reject</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">s3</span><span class=\"p\">.</span><span class=\"nx\">upload</span><span class=\"p\">(</span>\n            <span class=\"p\">{</span> <span class=\"na\">Bucket</span><span class=\"p\">:</span> <span class=\"nx\">bucket</span><span class=\"p\">,</span> <span class=\"na\">Key</span><span class=\"p\">:</span> <span class=\"nx\">key</span><span class=\"p\">,</span> <span class=\"na\">Body</span><span class=\"p\">:</span> <span class=\"nx\">buffer</span><span class=\"p\">,</span> <span class=\"na\">ContentType</span><span class=\"p\">:</span> <span class=\"nx\">mimeType</span> <span class=\"p\">},</span>\n            <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">,</span> <span class=\"nx\">data</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"nx\">reject</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">);</span>\n                <span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">)</span>\n            <span class=\"p\">})</span>\n    <span class=\"p\">})</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">resize</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">buffer</span><span class=\"p\">,</span> <span class=\"nx\">mimeType</span><span class=\"p\">,</span> <span class=\"nx\">width</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span>\n    <span class=\"k\">new</span> <span class=\"nb\">Promise</span><span class=\"p\">((</span><span class=\"nx\">resolve</span><span class=\"p\">,</span> <span class=\"nx\">reject</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">Jimp</span><span class=\"p\">.</span><span class=\"nx\">read</span><span class=\"p\">(</span><span class=\"nx\">buffer</span><span class=\"p\">)</span>\n        <span class=\"p\">.</span><span class=\"nx\">then</span><span class=\"p\">(</span><span class=\"nx\">image</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">image</span><span class=\"p\">.</span><span class=\"nx\">resize</span><span class=\"p\">(</span><span class=\"nx\">width</span><span class=\"p\">,</span> <span class=\"nx\">Jimp</span><span class=\"p\">.</span><span class=\"nx\">AUTO</span><span class=\"p\">).</span><span class=\"nx\">quality</span><span class=\"p\">(</span><span class=\"mi\">70</span><span class=\"p\">).</span><span class=\"nx\">getBufferAsync</span><span class=\"p\">(</span><span class=\"nx\">mimeType</span><span class=\"p\">))</span>\n        <span class=\"p\">.</span><span class=\"nx\">then</span><span class=\"p\">(</span><span class=\"nx\">resizedBuffer</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">resizedBuffer</span><span class=\"p\">))</span>\n        <span class=\"p\">.</span><span class=\"k\">catch</span><span class=\"p\">(</span><span class=\"nx\">error</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">reject</span><span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">))</span>\n    <span class=\"p\">})</span>\n</code></pre></div>\n\n\n\n<p>Well, so far we have reviewed each of the code blocks that allow image processing, validation and uploading to S3, however, the control file <strong>serverless.yml</strong> of the serverless framework needs to be covered, which allows us to detail the resources , service definitions, roles, settings, permissions, and more for our service.<br>\n</p>\n\n<div class=\"highlight\"><pre class=\"highlight yaml\"><code><span class=\"c1\">#serverles.yml</span>\n<span class=\"na\">service</span><span class=\"pi\">:</span> <span class=\"s\">file-UploaderService-foqc-home</span>\n<span class=\"na\">custom</span><span class=\"pi\">:</span>\n    <span class=\"na\">bucket</span><span class=\"pi\">:</span> <span class=\"s\">lambda-test-foqc-file-home</span>\n<span class=\"na\">provider</span><span class=\"pi\">:</span>\n    <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">aws</span>\n    <span class=\"na\">runtime</span><span class=\"pi\">:</span> <span class=\"s\">nodejs12.x</span>\n    <span class=\"na\">region</span><span class=\"pi\">:</span> <span class=\"s\">us-east-1</span>\n    <span class=\"na\">stackName</span><span class=\"pi\">:</span> <span class=\"s\">fileUploaderHome</span>\n    <span class=\"na\">apiGateway</span><span class=\"pi\">:</span>\n        <span class=\"na\">binaryMediaTypes</span><span class=\"pi\">:</span>\n            <span class=\"pi\">-</span> <span class=\"s1\">'</span><span class=\"s\">*/*'</span>\n    <span class=\"na\">iamRoleStatements</span><span class=\"pi\">:</span>\n        <span class=\"pi\">-</span> <span class=\"na\">Effect</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">Allow\"</span>\n        <span class=\"na\">Action</span><span class=\"pi\">:</span>\n            <span class=\"pi\">-</span> <span class=\"s2\">\"</span><span class=\"s\">s3:PutObject\"</span>\n            <span class=\"pi\">-</span> <span class=\"s2\">\"</span><span class=\"s\">s3:GetObject\"</span>\n        <span class=\"na\">Resource</span><span class=\"pi\">:</span>\n            <span class=\"pi\">-</span> <span class=\"s2\">\"</span><span class=\"s\">arn:aws:s3:::${self:custom.bucket}/*\"</span>\n<span class=\"na\">functions</span><span class=\"pi\">:</span>\n    <span class=\"na\">UploadFileHome</span><span class=\"pi\">:</span>\n        <span class=\"na\">handler</span><span class=\"pi\">:</span> <span class=\"s\">fileUploaderHome.handler</span>\n        <span class=\"na\">events</span><span class=\"pi\">:</span>\n            <span class=\"pi\">-</span> <span class=\"na\">http</span><span class=\"pi\">:</span>\n                <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">upload</span>\n                <span class=\"na\">method</span><span class=\"pi\">:</span> <span class=\"s\">post</span>\n                <span class=\"na\">cors</span><span class=\"pi\">:</span> <span class=\"no\">true</span>\n        <span class=\"na\">environment</span><span class=\"pi\">:</span> <span class=\"na\">Bucket</span><span class=\"pi\">:</span> <span class=\"s\">${self:custom.bucket}</span>\n<span class=\"na\">resources</span><span class=\"pi\">:</span>\n    <span class=\"na\">Resources</span><span class=\"pi\">:</span>\n        <span class=\"na\">StorageBucket</span><span class=\"pi\">:</span>\n            <span class=\"na\">Type</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">AWS::S3::Bucket\"</span>\n            <span class=\"na\">Properties</span><span class=\"pi\">:</span>\n                <span class=\"na\">BucketName</span><span class=\"pi\">:</span> <span class=\"s\">${self:custom.bucket}</span>\n</code></pre></div>\n\n\n\n<ol>\n<li><p><strong>service</strong>, refers to a project, is the name with which it will be deployed.</p></li>\n<li><p><strong>custom</strong>, this section allows defining variables that can be used at various points in the document, centralizing the values ​​for development or deployment, therefore we add the bucket variable, with the value <strong><em>lambda-test-foqc-file-home</em></strong>, this value will be used to define the bucket in which the files will be stored.</p></li>\n<li><p><strong>Provider</strong>, in this section the provider, the infrastructure and the respective permissions of resources is defined. As mentioned at the beginning of this blog, the provider to use is <strong>Amazon Web Services (aws)</strong>,  <strong>NodeJs 12</strong>, <strong>region</strong> in which it will be deployed is in the <strong>eastern United States</strong>, the default name of the <strong>CloudFormation stack (fileUploaderHome)</strong>, however it is not required.<br>\nThe following line is important, to allow our <strong>Api Gateway</strong> support binary files; It is mandatory to declare the section <strong><em>apiGateway</em></strong> which has as one of its values ​​<strong>'* / *'</strong>, which is a <strong>wildcard</strong> that defines, that any binary format, such as <strong>multipart/form-data</strong>, will be accepted. Then the <strong>permissions (iamRoleStatements)</strong> are defined, to allow access to S3 bucket, defined in the customization section <strong>${self.custom.bucket}</strong>.</p></li>\n<li><p><strong>Functions</strong>, this section defines each of the implementations of <strong>functions as services (Faas)</strong>, it is a minimum unit of deployment, a service can be composed of several functions, and each of these must fulfill a single task, although it is just a recommendation. Each function must have a specific configuration, otherwise it will inherit one by default.<br>\nThe name of our function will be the following, <strong>UploadFileHome</strong>, which is invoked from an HTTP POST event in the path that is fired on demand and <strong>allows CORS</strong>, this event will be handled by our handler function that has already been implemented in the file *<em>fileUploaderHome</em>.</p></li>\n<li><p><strong>Resources</strong>, finally in this section the resources to be used by each of the functions, defined above, are defined. The storage bucket <strong>(StorageBucket)</strong> is defined, which has the type <strong>(Type: 'AWS :: S3 :: Bucket')</strong> and in the property the name of the bucket <strong>(BucketName)</strong>.</p></li>\n</ol>\n\n<p><strong>Finally!</strong> We have finished building our service, which uploads an image and its thumbnail to S3, so it is time to deploy the service, with the following command.<br>\n</p>\n\n<div class=\"highlight\"><pre class=\"highlight shell\"><code>sls deploy <span class=\"nt\">--stage</span><span class=\"o\">=</span><span class=\"nb\">test</span>\n</code></pre></div>\n\n\n\n<p>At the end of the deployment, the url of our service will be displayed, test its operation using postman, as shown in the image.<br>\n<a href=\"https://res.cloudinary.com/practicaldev/image/fetch/s--cA5q2YHA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/dwhaxx0cxvtkny1h1ub6.png\" class=\"article-body-image-wrapper\"><img src=\"https://res.cloudinary.com/practicaldev/image/fetch/s--cA5q2YHA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/dwhaxx0cxvtkny1h1ub6.png\" alt=\"Alt Text\" loading=\"lazy\"></a></p>\n\n<p>If the image uploading was successful, the service will return a JSON, with the information of the processed image, such as the key, the name, the url of the original file and the thumbnail.</p>\n\n<p>To conclude, in case you need to remove the service, run the following command.<br>\n</p>\n\n<div class=\"highlight\"><pre class=\"highlight shell\"><code>sls remove <span class=\"nt\">--stage</span><span class=\"o\">=</span><span class=\"nb\">test</span>\n</code></pre></div>\n\n\n\n<h2>\n  <a name=\"conclusions\" href=\"#conclusions\" class=\"anchor\">\n  </a>\n  Conclusions\n</h2>\n\n<p>This service can be used on demand by any external application or service, since it is not coupled to any business logic, in addition the code can be refactored so it can upload files in general, <strong>not only images, it could also receive as part of the http post event, the directory (path) of the bucket where you want to store the file</strong>, avoiding having a fixed directory. However, in a didactic way, it serves as a basis for creating a more robust and configurable service.</p>\n\n<p>It has taken me several days to document and write this post, I am satisfied and I hope that this information has been useful for you.</p>\n\n<p><strong>Thank you!</strong></p>\n\n","url":"https://dev.to/foqc/uploading-images-to-aws-s3-with-serverless-1ae0"}}},"pageContext":{"id":"uploading-images-to-aws-s3-with-serverless-1ae0"}}}